#!/bin/bash
# GitHub App Authentication Setup Tool
# Finds PEM files and sets up git credential helper

set -e

echo "Setting up GitHub App authentication..."

# Find the project root by looking for system/tools (where this script is)
SCRIPT_DIR="$(dirname "$(realpath "$0")")"
TOOLS_DIR="$(dirname "$SCRIPT_DIR")"
SYSTEM_DIR="$(dirname "$TOOLS_DIR")"

# Determine working directory context
if [[ "$SYSTEM_DIR" == */claude-habitat/system ]]; then
    # We're in normal mode: /path/to/project/claude-habitat/system
    PROJECT_ROOT="$(dirname "$(dirname "$SYSTEM_DIR")")"
    SHARED_DIR="$PROJECT_ROOT/claude-habitat/shared"
elif [[ "$SYSTEM_DIR" == */system ]]; then
    # We're in bypass mode: /workspace/src/system  
    PROJECT_ROOT="$(dirname "$SYSTEM_DIR")"
    SHARED_DIR="$PROJECT_ROOT/../shared"
    if [ ! -d "$SHARED_DIR" ]; then
        SHARED_DIR="$PROJECT_ROOT/shared"
    fi
fi

echo "Project root: $PROJECT_ROOT"
echo "Shared directory: $SHARED_DIR"

# Find PEM file
PEM_FILE=""
if [ -d "$SHARED_DIR" ]; then
    PEM_FILE=$(find "$SHARED_DIR" -name "*.pem" -type f | sort -r | head -1)
fi

if [ -z "$PEM_FILE" ] || [ ! -f "$PEM_FILE" ]; then
    echo "❌ No GitHub App PEM file found in $SHARED_DIR"
    echo "GitHub authentication will not be available"
    exit 1
fi

echo "✅ Found PEM file: $PEM_FILE"

# Check for required environment variables
if [ -z "$GITHUB_APP_ID" ]; then
    echo "❌ GITHUB_APP_ID environment variable not set"
    exit 1
fi

echo "✅ Using GitHub App ID: $GITHUB_APP_ID"

# Create git credential helper script in tools directory
CREDENTIAL_HELPER="$TOOLS_DIR/bin/git-credential-github-app"
cat > "$CREDENTIAL_HELPER" << 'EOF'
#!/bin/bash
# Git credential helper for GitHub App authentication
# Generates fresh tokens on each use to avoid expiration issues

if [ "$1" = "get" ]; then
    # Read the input (required by git credential protocol)
    while read -r line; do
        if [ -z "$line" ]; then
            break
        fi
    done
    
    # Use environment variables set by setup-github-auth
    if [ -f "$GITHUB_APP_PEM_FILE" ] && [ -n "$GITHUB_APP_ID" ]; then
        # Generate JWT for GitHub App
        header='{"alg":"RS256","typ":"JWT"}'
        payload="{\"iat\":$(date +%s),\"exp\":$(($(date +%s) + 600)),\"iss\":\"$GITHUB_APP_ID\"}"
        
        # Encode header and payload
        header_b64=$(echo -n "$header" | base64 -w 0 | tr '+/' '-_' | tr -d '=')
        payload_b64=$(echo -n "$payload" | base64 -w 0 | tr '+/' '-_' | tr -d '=')
        
        # Create signature
        signature=$(echo -n "$header_b64.$payload_b64" | openssl dgst -sha256 -sign "$GITHUB_APP_PEM_FILE" | base64 -w 0 | tr '+/' '-_' | tr -d '=' 2>/dev/null)
        
        if [ -n "$signature" ]; then
            # Create JWT
            jwt="$header_b64.$payload_b64.$signature"
            
            # Get installation token with error handling
            installations_response=$(curl -s -H "Authorization: Bearer $jwt" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/app/installations" 2>/dev/null)
            installation_id=$(echo "$installations_response" | jq -r '.[0].id' 2>/dev/null)
            
            if [ "$installation_id" != "null" ] && [ -n "$installation_id" ] && [ "$installation_id" != "" ]; then
                token_response=$(curl -s -X POST -H "Authorization: Bearer $jwt" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/app/installations/$installation_id/access_tokens" 2>/dev/null)
                token=$(echo "$token_response" | jq -r '.token' 2>/dev/null)
                
                if [ "$token" != "null" ] && [ -n "$token" ] && [ "$token" != "" ]; then
                    echo "username=x-access-token"
                    echo "password=$token"
                    exit 0
                fi
            fi
        fi
    fi
    
    # Fallback: no token available
    echo "username="
    echo "password="
fi
EOF

chmod +x "$CREDENTIAL_HELPER"
echo "✅ Created git credential helper: $CREDENTIAL_HELPER"

# Set environment variables for the credential helper
export GITHUB_APP_PEM_FILE="$PEM_FILE"
echo "export GITHUB_APP_PEM_FILE=\"$PEM_FILE\"" >> ~/.bashrc

# Configure git to use our credential helper for GitHub
git config --global credential."https://github.com".helper "$CREDENTIAL_HELPER"
echo "✅ Configured git to use credential helper"

echo "✅ GitHub App authentication setup complete!"
echo ""
echo "Environment:"
echo "  GITHUB_APP_ID=$GITHUB_APP_ID"
echo "  GITHUB_APP_PEM_FILE=$PEM_FILE"
echo "  Git credential helper: $CREDENTIAL_HELPER"