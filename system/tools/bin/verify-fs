#!/bin/bash
# verify-fs - Simple filesystem verification

SCOPE="${1:-all}"
source "$SYSTEM_PATH/tools/tap-helpers.sh"

echo "TAP version 13"

check_config() {
    local config="$1" name="$2"
    if [[ ! -f "$config" ]]; then return 0; fi
    
    local files
    files=$(yq eval '.verify-fs.required_files[]' "$config" 2>/dev/null)
    
    while IFS= read -r file; do
        if [[ -n "$file" && "$file" != "null" ]]; then
            expanded=$(eval echo "\"$file\"")
            # Debug specific failing files
            if [[ "$expanded" == "/root/.gitconfig" || "$expanded" == ~/.gitconfig || "$expanded" == ~/.claude/.credentials.json ]]; then
                echo "# DEBUG: Checking $expanded (original: $file)" >&2
                echo "# DEBUG: Current user: $(whoami)" >&2
                echo "# DEBUG: Home directory: $HOME" >&2
                ls -la "$expanded" 2>&1 >&2 || echo "# DEBUG: ls failed for $expanded" >&2
            fi
            if [[ -e "$expanded" ]]; then
                tap_ok "File exists: $expanded ($name)"
            else
                tap_not_ok "File missing: $expanded ($name)"
            fi
        fi
    done <<< "$files"
}

case "$SCOPE" in
    "system") check_config "$SYSTEM_PATH/config.yaml" "system" ;;
    "shared") check_config "$SHARED_PATH/config.yaml" "shared" ;;
    "habitat") check_config "$LOCAL_PATH/config.yaml" "habitat" ;;
    "all") 
        check_config "$SYSTEM_PATH/config.yaml" "system"
        check_config "$SHARED_PATH/config.yaml" "shared" 
        check_config "$LOCAL_PATH/config.yaml" "habitat"
        ;;
esac

echo "1..$test_num"