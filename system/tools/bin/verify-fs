#!/bin/bash
# verify-fs - Simple filesystem verification

SCOPE="${1:-all}"
source "$SYSTEM_PATH/tools/tap-helpers.sh"

echo "TAP version 13"

check_config() {
    local config="$1" name="$2"
    if [[ ! -f "$config" ]]; then return 0; fi
    
    local files
    files=$(yq eval '.verify-fs.required_files[]' "$config" 2>/dev/null)
    
    while IFS= read -r file; do
        if [[ -n "$file" && "$file" != "null" ]]; then
            expanded=$(eval echo "\"$file\"")
            if [[ -e "$expanded" ]]; then
                tap_ok "File exists: $expanded ($name)"
            else
                tap_not_ok "File missing: $expanded ($name)"
            fi
        fi
    done <<< "$files"
}

case "$SCOPE" in
    "system") check_config "$SYSTEM_PATH/config.yaml" "system" ;;
    "shared") check_config "$SHARED_PATH/config.yaml" "shared" ;;
    "habitat") check_config "$LOCAL_PATH/config.yaml" "habitat" ;;
    "all") 
        check_config "$SYSTEM_PATH/config.yaml" "system"
        check_config "$SHARED_PATH/config.yaml" "shared" 
        check_config "$LOCAL_PATH/config.yaml" "habitat"
        ;;
esac

echo "1..$test_num"